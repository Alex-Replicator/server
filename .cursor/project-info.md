# Проект: Docker-сборка для PHP-проектов

## General

### Краткое описание
Универсальная Docker-сборка для разработки и деплоя PHP-проектов с веб-сервером, базой данных и кэшированием.

### Детальное описание
Проект представляет собой готовую к использованию Docker-конфигурацию, которая может быть подключена как Git-подмодуль к любому PHP-проекту. Сборка поддерживает PHP 8.1, интеграцию с MySQL 8.0, Memcached, Nginx 1.25, а также предоставляет инструменты для управления базой данных (Adminer). Ключевая особенность - унифицированная конфигурация для разработки и продакшена с переключением через переменные окружения.

### Стек технологий
- **Веб-сервер**: Nginx 1.25
- **Бэкенд**: PHP 8.1
- **База данных**: MySQL 8.0
- **Кэширование**: Memcached
- **Инструменты администрирования**: Adminer
- **CI/CD**: GitHub Actions
- **Контейнеризация**: Docker, Docker Compose

### Файловая структура
```
docker-build/
├── server/                      # это ТЕКУЩАЯ директория
│   ├── .env                     # Файл с переменными окружения
│   ├── docker-compose.yml       # Основной файл Docker Compose
│   ├── bin/                     # Директория с Dockerfile для каждого сервиса
│   │   ├── php/                 # Сборки для PHP
│   │   │   └── 8.1/             # PHP 8.1
│   │   ├── nginx/               # Dockerfile для Nginx
│   │   ├── mysql/               # Dockerfile для MySQL
│   │   └── memcached/           # Dockerfile для Memcached
│   ├── config/                  # Конфигурационные файлы для сервисов
│   │   ├── nginx/               # Конфиги Nginx
│   │   ├── php/                 # Конфиги PHP
│   │   └── mysql/               # Конфиги MySQL
│   ├── logs/                    # Логи всех сервисов
│   └── scripts/                 # Скрипты для CI/CD и утилиты
├── src/                         # Директория с кодом проекта (не входит в репозиторий)
│   └── public/                  # Публичная директория для веб-сервера
└── .github/                     # Конфигурация GitHub Actions
    └── workflows/               # Workflow-файлы для CI/CD
```

### Взаимодействие компонентов
1. **Nginx** выступает как веб-сервер и проксирует запросы к PHP-FPM
2. **PHP-FPM** обрабатывает PHP-код и взаимодействует с базой данных и кэшем (в PHP установлен полный набор расширений, как на стандартном хостинге)
3. **MySQL** хранит данные приложения
4. **Memcached** используется для кэширования данных
5. **Adminer** предоставляет веб-интерфейс для управления базой данных
6. **GitHub Actions** автоматизирует процесс деплоя на удаленный сервер

### Дополнительные заметки
- Все файлы проекта монтируются в контейнеры, а не копируются
- Логи каждого сервиса выводятся в отдельные файлы для удобства отладки
- Конфигурация универсальна для разработки и продакшена (управляется через переменные окружения)
- Синхронизация с удаленным сервером настраивается через GitHub Actions
- Тестовый скрипт в src/public/index.php проверяет подключение к MySQL и Memcached

## Architecture

### Общая архитектура
Архитектура построена на микросервисах, каждый из которых работает в отдельном контейнере Docker. Сервисы взаимодействуют по внутренней сети, созданной Docker Compose. Вся конфигурация централизована через переменные окружения, что позволяет легко адаптировать сборку под разные проекты и среды выполнения.

### Ключевые компоненты
1. **Контейнер Nginx**: Обрабатывает HTTP-запросы, обслуживает статический контент, проксирует динамические запросы к PHP
2. **Контейнер PHP-FPM**: Исполняет PHP-код, обрабатывает бизнес-логику приложения
3. **Контейнер MySQL**: Хранит данные, обеспечивает их целостность и предоставляет API для работы с ними
4. **Контейнер Memcached**: Обеспечивает быстрый доступ к кэшированным данным
5. **Контейнер Adminer**: Предоставляет веб-интерфейс для работы с базой данных

### Технические решения
- **Единая конфигурация для разработки и продакшена**: Вместо отдельных конфигураций для dev и prod используется единая конфигурация с переключением через переменную DEBUG в .env
- **Монтирование файлов вместо копирования**: Все файлы проекта монтируются в контейнеры, что ускоряет разработку и отладку
- **Автоматический CI/CD**: При пуше в репозиторий происходит автоматическая синхронизация с удаленным сервером через GitHub Actions
- **Настраиваемая синхронизация БД**: Можно выбрать, синхронизировать только код или код вместе с данными БД

### Нефункциональные аспекты
- **Производительность**: Оптимизация конфигураций Nginx и PHP-FPM для быстрой обработки запросов, использование Memcached для кэширования
- **Безопасность**: Изоляция сервисов в отдельных контейнерах, хранение секретных данных в .env и secret.txt
- **Масштабируемость**: Возможность горизонтального масштабирования через репликацию контейнеров
- **Удобство разработки**: Hot-reload для быстрой отладки, монтирование файлов, централизованное логирование
- **Переносимость**: Работает в любой среде, где установлен Docker и Docker Compose

## Design

### Пользовательские пожелания
- Универсальная Docker-сборка для PHP-проектов
- Структура с подключением в виде Git-подмодуля (server в корне проекта)
- Единая конфигурация для разработки и продакшена (переключение через debug-переменную)
- Монтирование файлов вместо копирования
- Вывод логов в отдельные файлы
- Отдельные конфигурационные файлы для каждого сервиса
- Простой CI/CD с синхронизацией через GitHub Actions
- Поддержка различных режимов синхронизации (только код или код + БД)

### Ключевые решения
- Использование MySQL 8.0 как наиболее распространенной и хорошо документированной СУБД для PHP-проектов
- Выбор Nginx 1.25 в качестве веб-сервера из-за производительности и удобства настройки
- Adminer вместо PHPMyAdmin для управления БД (легче и быстрее)
- Реализация CI/CD через GitHub Actions для простоты настройки и использования

## Progress

### Этапы
- [x] **Этап 1**: Настройка базовой структуры проекта
  - [x] **Задача 1.1**: Создание структуры директорий
    - Ожидаемый результат: Созданы директории bin, config, logs, scripts с соответствующими поддиректориями
    - Критерии проверки: Наличие всех директорий с правильной структурой
  - [x] **Задача 1.2**: Создание базового docker-compose.yml
    - Ожидаемый результат: Основной файл Docker Compose с описанием всех сервисов
    - Критерии проверки: Возможность запуска всех контейнеров через docker-compose up

- [x] **Этап 2**: Настройка веб-сервера и PHP
  - [x] **Задача 2.1**: Создание Dockerfile для PHP 8.1
    - Ожидаемый результат: Dockerfile для PHP 8.1 с необходимыми расширениями
    - Критерии проверки: Успешная сборка и запуск контейнера с PHP
  - [x] **Задача 2.2**: Настройка Nginx
    - Ожидаемый результат: Dockerfile и конфигурация для Nginx
    - Критерии проверки: Доступность веб-сервера по указанному порту

- [x] **Этап 3**: Настройка базы данных и вспомогательных сервисов
  - [x] **Задача 3.1**: Настройка MySQL
    - Ожидаемый результат: Dockerfile и конфигурация для MySQL с переменными из .env
    - Критерии проверки: Подключение к БД через клиент
  - [x] **Задача 3.2**: Настройка Memcached
    - Ожидаемый результат: Dockerfile и конфигурация для Memcached
    - Критерии проверки: Подключение к Memcached через telnet
  - [x] **Задача 3.3**: Настройка Adminer
    - Ожидаемый результат: Добавление контейнера Adminer в docker-compose.yml
    - Критерии проверки: Доступность Adminer через браузер по указанному порту

- [x] **Этап 4**: Настройка логирования
  - [x] **Задача 4.1**: Настройка логирования для всех сервисов
    - Ожидаемый результат: Все логи сервисов записываются в соответствующие файлы в директории logs
    - Критерии проверки: Наличие и корректное обновление log-файлов

- [x] **Этап 5**: Настройка CI/CD через GitHub Actions
  - [x] **Задача 5.1**: Создание скриптов для деплоя
    - Ожидаемый результат: Bash-скрипты для синхронизации кода и БД
    - Критерии проверки: Успешное выполнение скриптов вручную
  - [x] **Задача 5.2**: Настройка GitHub Actions workflow
    - Ожидаемый результат: Файлы конфигурации для GitHub Actions
    - Критерии проверки: Автоматический деплой при пуше в репозиторий

- [x] **Этап 6**: Тестирование и документация
  - [x] **Задача 6.1**: Создание тестового PHP-проекта
    - Ожидаемый результат: Простой PHP-проект для тестирования сборки
    - Критерии проверки: Успешное выполнение PHP-скриптов, подключение к БД и Memcached
  - [x] **Задача 6.2**: Создание документации по использованию
    - Ожидаемый результат: README с инструкциями по установке и использованию
    - Критерии проверки: Возможность запустить проект, следуя только инструкциям

## Autonomous Decisions

### 2025-03-24 - Выбор MySQL в качестве основной СУБД
- **Решение**: Использовать MySQL 8.0 вместо PostgreSQL или других СУБД
- **Обоснование**: MySQL имеет наилучшую интеграцию с PHP-проектами, широко используется в CMS и веб-приложениях, хорошо документирован
- **Альтернативы**: 
  1. PostgreSQL: Более мощный, но имеет некоторые особенности интеграции с PHP
  2. SQLite: Слишком ограничен для многих проектов, не подходит для высоконагруженных систем
- **Критерии выбора**: Совместимость с PHP, распространенность, простота настройки

### 2025-03-24 - Выбор Nginx вместо Apache
- **Решение**: Использовать Nginx 1.25 в качестве веб-сервера
- **Обоснование**: Nginx обеспечивает лучшую производительность, меньшее потребление ресурсов, удобнее настраивается для современных PHP-приложений
- **Альтернативы**: 
  1. Apache: Более распространен, но менее эффективен для высоконагруженных приложений
- **Критерии выбора**: Производительность, масштабируемость, простота конфигурации

### 2025-03-24 - Выбор Adminer вместо PHPMyAdmin
- **Решение**: Использовать Adminer для управления базой данных
- **Обоснование**: Adminer легче, быстрее загружается и поддерживает больше типов баз данных при необходимости
- **Альтернативы**: 
  1. PHPMyAdmin: Более распространен, но тяжелее и требует больше ресурсов
- **Критерии выбора**: Скорость работы, простота установки, минимальные требования

### 2025-03-24 - Выбор GitHub Actions для CI/CD
- **Решение**: Реализовать CI/CD через GitHub Actions
- **Обоснование**: Интегрируется напрямую с GitHub, не требует настройки внешних сервисов, имеет простой синтаксис
- **Альтернативы**: 
  1. Jenkins: Требует отдельного сервера и сложнее в настройке
  2. GitLab CI: Требует использования GitLab
  3. Простые bash-скрипты: Менее функциональны и требуют ручного запуска
- **Критерии выбора**: Простота настройки и использования, интеграция с GitHub 

### 2025-03-24 - Выбор PHP 8.1
- **Решение**: Использовать PHP 8.1
- **Обоснование**: PHP 8.1 - стабильная версия с хорошей поддержкой, современными возможностями и оптимальной производительностью
- **Альтернативы**: 
  1. PHP 7.4: Устаревающая версия с окончанием активной поддержки
  2. PHP 8.0: Отсутствуют некоторые улучшения 8.1
  3. PHP 8.2/8.3: Более новые версии, но могут иметь проблемы совместимости с некоторыми проектами
- **Критерии выбора**: Баланс между современными возможностями и стабильностью, широкая поддержка фреймворками 